@using Domain.Products.Entities
@using Domain.Products.Repositories
@using Application.Products
@using Domain.PurchasedProducts.Entities;
@using Domain.PurchasedProducts.Repositories;
@using Application.PurchasedProducts;

@using System.Globalization
@inject IProductService ProductService
@inject IPurchasedProductService PurchaseProductService
@inject ISnackbar Snackbar
@inject NavigationManager nav
@page "/"

<MudText Align="Align.Center" Typo="Typo.h4" GutterBottom="true">Vending Machine</MudText>
 <MudSpacer/> <MudSpacer/>
<MudGrid>
	<MudItem xs="6">
		<MudText Align="Align.Center" Typo="Typo.h5">Available drinks</MudText>
		<MudTable @ref="_tableAvailableDrinks" Items="@_productsList" Hover="true" Breakpoint="Breakpoint.Sm">
			<HeaderContent>
				<MudTh Style="text-align:justify-all">Stock</MudTh>
				<MudTh Style="text-align:justify-all">Name</MudTh>
				<MudTh Style="text-align:justify-all">Price</MudTh>
			</HeaderContent>
			<RowTemplate>
				<MudTd Style="text-align:justify-all" DataLabel="Stock">@context.Stock</MudTd>
				<MudTd Style="text-align:justify-all" DataLabel="Name">@context.Name</MudTd>
				<MudTd Style="text-align:justify-all" DataLabel="Price">@PriceFormat(context.Price)</MudTd>
			</RowTemplate>
		</MudTable>

	</MudItem>
	<MudItem xs="6">
		<MudText Align="Align.Left" Typo="Typo.h5">Purchase products</MudText> <MudSpacer/> <MudSpacer/>
		<MudForm @ref="_form">
			 <MudItem xs="8">
				<MudSelect typeof="int" @bind-Value="_purchasedProduct.Name" Label="Drink name" Required="true" 
				RequiredError="Choose a product" Variant="Variant.Outlined">
					<MudSelectItem Value="@("Coca Cola")">Coca Cola</MudSelectItem>
					<MudSelectItem Value="@("Pepsi")">Pepsi</MudSelectItem>
					<MudSelectItem Value="@("Fanta")">Fanta</MudSelectItem>
					<MudSelectItem Value="@("Sprite")">Sprite</MudSelectItem>
				</MudSelect>
             </MudItem>
			 <MudItem xs="2"></MudItem>
			 <MudItem xs="8">
				<MudNumericField @bind-Value="_purchasedProduct.Amount" Min="1" Label="Enter the amount of products" Variant="Variant.Outlined"></MudNumericField>
             </MudItem>

        </MudForm>
		<MudToolBar DisableGutters="true" Class="gap-4"><MudButton Variant="Variant.Filled" OnClick="AddProductsToPurchase" Color="Color.Secondary">Buy</MudButton></MudToolBar>
	</MudItem>
</MudGrid>



@code {
	private MudTable<Product> _tableAvailableDrinks;
	private IEnumerable<Product> _productsList;
	private CultureInfo _cultureCR = CultureInfo.GetCultureInfo("es-CR");
	private MudForm _form;
	private PurchasedProduct _purchasedProduct = new PurchasedProduct("",0,0.0,"Canned Soda");
	private Product _product = new Product(0, "", 0.0, "");

	protected override async Task OnInitializedAsync()
	{
		_productsList = ProductService.GetAllProducts();
	}

	private async Task AddProductsToPurchase()
	{
		GetPriceByProductName(_purchasedProduct);
		foreach(Product element in _productsList)
		{
			if(element.Name == _purchasedProduct.Name)
			{
				if (element.Stock < _purchasedProduct.Amount)
				{
					Snackbar.Add("the quantity entered is greater than the quantity in stock", Severity.Warning);
				}
				else
				{
					PurchaseProductService.AddPurchasedProduct(_purchasedProduct);
					Snackbar.Add("Added products to pay", Severity.Success);
					ProductService.UpdateProductStock(element,_purchasedProduct.Amount);
				}
			}
		}
		await Task.Delay(2000);
		nav.NavigateTo($"/");
	}

	private void GetPriceByProductName(PurchasedProduct purchasedProduct)
	{
		foreach(Product item in _productsList)
		{
			if(item.Name == purchasedProduct.Name)
			{
				_purchasedProduct.Price = item.Price;
			}
		}
	}

	private string PriceFormat(double price)
	{
		string formatedPrice = string.Format("{0:N}", price);
		formatedPrice = _cultureCR.NumberFormat.CurrencySymbol + formatedPrice;
		return formatedPrice;
    }
}
